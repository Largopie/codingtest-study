name: Problem Solving Notification
on:
  push:
    branches: [ main ]
    paths:
      - 'ë°±ì¤€/**/*.md'
      - 'í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤/**/*.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python3 - <<EOF
          import os
          import re
          import requests
          
          def get_problem_info(file_path, content):
              # í´ë” êµ¬ì¡°ì—ì„œ ì •ë³´ ì¶”ì¶œ
              parts = file_path.split('/')
              platform = parts[0]  # 'ë°±ì¤€' ë˜ëŠ” 'í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤'
              tier = parts[1]      # 'Bronze', 'Silver' ë“±
              
              # ë¬¸ì œ ë²ˆí˜¸ì™€ ì œëª© ì¶”ì¶œ
              problem_folder = parts[2]
              number = problem_folder.split('.')[0]
              
              # ë¬¸ì œ ë§í¬ ì¶”ì¶œ
              if platform == 'ë°±ì¤€':
                  link_pattern = r'\[ë¬¸ì œ ë§í¬\]\((https://www\.acmicpc\.net/problem/\d+)\)'
                  match = re.search(link_pattern, content)
                  problem_link = match.group(1) if match else None
              elif platform == 'í”„ë¡œê·¸ëž˜ë¨¸ìŠ¤':
                  link_pattern = r'\[ë¬¸ì œ ë§í¬\]\((https://programmers\.co\.kr/learn/courses/\d+/lessons/\d+)\)'
                  match = re.search(link_pattern, content)
                  problem_link = match.group(1) if match else None
              
              return {
                  'platform': platform,
                  'tier': tier,
                  'number': number,
                  'link': problem_link
              }
          
          def create_discord_message(problem_info):
              platform_emoji = "ðŸŽ¯" if problem_info['platform'] == 'ë°±ì¤€' else "ðŸ’»"
              return f"{platform_emoji} **{problem_info['platform']}** {problem_info['tier']} ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤!\në¬¸ì œ ë§í¬: {problem_info['link']}"
          
          # ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ ì°¾ê¸°
          new_files = os.popen('git diff --name-only HEAD HEAD~1').read().strip().split('\n')
          md_files = [f for f in new_files if f.endswith('README.md')]
          
          for md_file in md_files:
              if os.path.exists(md_file):
                  with open(md_file, 'r', encoding='utf-8') as f:
                      content = f.read()
                      problem_info = get_problem_info(md_file, content)
                      
                      if problem_info['link']:
                          # Discord ì›¹í›…ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
                          webhook_data = {
                              "content": create_discord_message(problem_info)
                          }
                          requests.post(os.environ['DISCORD_WEBHOOK_URL'], json=webhook_data)
          EOF
