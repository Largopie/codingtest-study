name: Problem Solving Notification
on:
  push:
    branches: [ main ]
    paths:
      - 'ë°±ì¤€/**/*.md'
      - 'í”„ë¡œê·¸ë˜ë¨¸ìŠ¤/**/*.md'

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ì˜ ë¹„êµë¥¼ ìœ„í•´ í•„ìš”

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          python3 - <<EOF
          import os
          import re
          import requests
          import json
          from datetime import datetime
          
          def get_problem_info(file_path, content):
              print(f"Processing file: {file_path}")  # ë””ë²„ê¹…
              parts = file_path.split('/')
              platform = parts[0]
              tier = parts[1]
              problem_folder = parts[2]
              number = problem_folder.split('.')[0]
              
              if platform == 'ë°±ì¤€':
                  link_pattern = r'\[ë¬¸ì œ ë§í¬\]\((https://www\.acmicpc\.net/problem/\d+)\)'
              else:
                  link_pattern = r'\[ë¬¸ì œ ë§í¬\]\((https://programmers\.co\.kr/learn/courses/\d+/lessons/\d+)\)'
              
              match = re.search(link_pattern, content)
              problem_link = match.group(1) if match else None
              print(f"Extracted link: {problem_link}")  # ë””ë²„ê¹…
              
              return {
                  'platform': platform,
                  'tier': tier,
                  'number': number,
                  'link': problem_link
              }
          
          def send_discord_webhook(problem_info):
              platform_emoji = "ğŸ¯" if problem_info['platform'] == 'ë°±ì¤€' else "ğŸ’»"
              
              webhook_data = {
                  "embeds": [{
                      "title": f"{platform_emoji} ìƒˆë¡œìš´ ë¬¸ì œ í•´ê²°!",
                      "description": f"**í”Œë«í¼**: {problem_info['platform']}\n**ë‚œì´ë„**: {problem_info['tier']}\n**ë¬¸ì œ ë²ˆí˜¸**: {problem_info['number']}\n**ë§í¬**: {problem_info['link']}",
                      "color": 0x00ff00,
                      "timestamp": datetime.utcnow().isoformat()
                  }]
              }
              
              try:
                  response = requests.post(
                      os.environ['DISCORD_WEBHOOK_URL'],
                      json=webhook_data,
                      headers={'Content-Type': 'application/json'}
                  )
                  response.raise_for_status()
                  print(f"Discord webhook response: {response.status_code}")  # ë””ë²„ê¹…
                  print(f"Response content: {response.text}")  # ë””ë²„ê¹…
              except Exception as e:
                  print(f"Error sending Discord webhook: {str(e)}")
                  raise
          
          # ìƒˆë¡œ ì¶”ê°€ëœ íŒŒì¼ ì°¾ê¸°
          new_files = os.popen('git diff --name-only HEAD HEAD~1').read().strip().split('\n')
          print(f"Changed files: {new_files}")  # ë””ë²„ê¹…
          
          md_files = [f for f in new_files if f.endswith('README.md')]
          print(f"Markdown files to process: {md_files}")  # ë””ë²„ê¹…
          
          for md_file in md_files:
              if os.path.exists(md_file):
                  print(f"Reading file: {md_file}")  # ë””ë²„ê¹…
                  with open(md_file, 'r', encoding='utf-8') as f:
                      content = f.read()
                      problem_info = get_problem_info(md_file, content)
                      
                      if problem_info['link']:
                          send_discord_webhook(problem_info)
          EOF
